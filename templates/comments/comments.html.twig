{% extends 'base.html.twig' %}

{% block contentcss %}
	<link href="{{ asset('assets/stylesheets/commentstyle.css') }}" rel="stylesheet"/>
{% endblock %}

{% block content %}

<div class="container mt-5">
    <form id="comment-form" action="add-comment.php">
        <div class="form-group row">
            <label for="name" class="col-sm-2 col-form-label">Name</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="name" name="name" placeholder="Your Name" required>
            </div>
        </div>

        <div class="form-group row">
            <label for="rating" class="col-sm-2 col-form-label">Rating</label>
            <div class="col-sm-10">
                <select class="form-control" id="rating" name="rating" required>
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                    <option value="1">1</option>
                </select>
            </div>
        </div>

        <div class="form-group row">
            <label for="comment" class="col-sm-2 col-form-label">Comment</label>
            <div class="col-sm-10">
                <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="Your comment" required></textarea>
            </div>
        </div>

        <div class="form-group row">
            <div class="col-sm-10 offset-sm-2">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </form>
</div>

<div class="container">
	<div class="row">
		{% for row in comments %}
			<div class="col-4 comment_card">
				<div class="card">
				<div class="checkbox-container" style="position:absolute; top:10px; right:10px">
                        {% if row.moderation == 1 %}
                            <input type="checkbox" checked data-item-id="{{ row.id }}">
                        {% else %}
                            <input type="checkbox" data-item-id="{{ row.id }}">
                        {% endif %}
                    </div>
					<div class="card-body py-3">
						<h5 class="card-title">{{ row.name }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ row.rating }}</h6>
						<p class="card-text">{{ row.comment }}</p>
					</div>
					<div class="card-footer">
						<small class="text-muted">{{ row.created|date('Y-m-d H:i:s') }}</small>
					</div>
				</div>
			</div>
		{% endfor %}
	</div>
</div>
<script>

// Add comment
document.addEventListener('DOMContentLoaded', function () {
    const commentForm = document.querySelector('#comment-form');

    if (commentForm) {
        commentForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(commentForm);

            fetch('/add-comment.php', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.errors) {
                    // Handle form errors
                    alert('Failed to add comment. Please check the form for errors.');
                    console.log(data.errors); // Log errors to the console for debugging
                } else {
                    // Comment added successfully
                    alert('Comment added successfully.');
                    // You can redirect or update the UI as needed
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the comment.');
            });
        });
    }
});


// Moderation Checkbox
document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    
    checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
            const isChecked = this.checked ? 1 : 0;
            const itemId = this.getAttribute('data-item-id');

            const formData = new FormData();
            formData.append('itemId', itemId);
            formData.append('isChecked', isChecked);

            // Modify the URL to fetch update-moderation.php from the public directory
            const updateModerationUrl = '/update-moderation.php';

            // Send an AJAX request to update the database
            fetch(updateModerationUrl, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (response.ok) {
                    alert('Moderation status updated successfully.');
                } else {
                    alert('Failed to update moderation status.');
                }
            });
        });
    });
});
</script>
{% endblock %}
